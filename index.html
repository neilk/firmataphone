<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="jquery-1.8.3.min.js"></script>
    <script src="handlebars-1.0.rc.1.js"></script>
    <script src="buzz.js"></script>
    <script>

        /**
         * todo:
         * add tones an octave above, but do not make them the , so that a
         */

        Cycle = (function() {
            var cycle = {};
            cycle.chromatic = {
                'c': 'c',
                'c-sharp': 'c♯',
                'd': 'd',
                'e-flat': 'e♭',
                'e': 'e',
                'f': 'f',
                'f-sharp': 'f♯',
                'g': 'g',
                'a-flat': 'a♭',
                'a': 'a',
                'b-flat': 'b♭',
                'b': 'b'
            };

            cycle.startSound = function(tone) {
                if (cycle.chromatic[tone].soundLeft && cycle.chromatic[tone].soundRight) {
                    cycle.chromatic[tone].soundLeft.bind('timeupdate', function(e) {
                        if (this.getTime() > 2.8) {
                            cycle.chromatic[tone].soundRight.play();
                            this.mute();
                        }
                    });

                    cycle.chromatic[tone].soundRight.bind('timeupdate', function(e) {
                        if (this.getTime() > 2.8) {
                            cycle.chromatic[tone].soundLeft.play();
                            this.mute();
                        }
                    });

                    cycle.chromatic[tone].soundLeft.bind('play', function(e) {
                        this.unmute();
                    });

                    cycle.chromatic[tone].soundRight.bind('play', function(e) {
                        this.unmute();
                        cycle.chromatic[tone].soundLeft.stop();
                    });

                } else {
                    throw new Exception('Sounds are not ready');
                }
            };

            // Initialize Cycle.chromatic
            $.each(cycle.chromatic, function(element, i) {
                var symbol = cycle.chromatic[element];
                cycle.chromatic[element] = {
                    symbol: symbol,
                    isPlaying: false
                };

                var pathTo = 'files/' + element + '.wav';
                $.ajax({
                    type: 'GET',
                    url: pathTo,
                    success: function() {
                        cycle.chromatic[element].soundLeft = new buzz.sound(pathTo, { loop: false });
                        cycle.chromatic[element].soundRight = new buzz.sound(pathTo, { loop: false });
                        // Hacked "seamless" playback
                        // http://forestmist.org/2010/04/html5-audio-loops/
                        // tl;dr: HTML5 Audio.loop doesn't work seamlessly in any browser.
                        // Two alternating sounds work around the gap.
                        cycle.chromatic[element].soundLeft.bind('timeupdate', function(e) {
                            if (this.getTime() > 2) {
                                cycle.chromatic[element].soundRight.play();
                                this.setTime(0);
                                this.pause();
                            }
                        });

                        cycle.chromatic[element].soundRight.bind('timeupdate', function(e) {
                            if (this.getTime() > 2) {
                                cycle.chromatic[element].soundLeft.play();
                                this.setTime(0);
                                this.pause();
                            }
                        });
                    },
                    error: function(jqxhr) {
                        console.log('how does this work');
                        console.log(jqxhr);

                    }
                })

            });

            cycle.togglePlay = function(noteName) {
                var tone = Cycle.chromatic[noteName];

                if (!tone) {
                    return false;
                }
                window.console.log(tone.isPlaying);

                if (tone.soundLeft) {
                    if (tone.isPlaying == false) {
                        restartSound(tone);
                        $('#' + noteName).addClass('pressed');
                    } else {
                        stopSound(tone);
                        $('#' + noteName).removeClass('pressed');
                    }

                    tone.isPlaying = !(tone.isPlaying);
                }
                return true;
            };

            return cycle;
        })();


        $.fn.extend({
             getObjectLength: function(obj) {
                 var size = 0;
                 for (var key in obj) {
                     if (obj.hasOwnProperty(key)) {
                         size++;
                     }
                 }
                 return size;
             },

            // From http://krazydad.com/tutorials/makecolors.php
            hslToColor: function(h, s, l) {
                return 'hsl(' + h + ',' + s + '%,' + l + '%)';
            },

            getColorRainbow: function(size) {
                var limit = 360; // degrees of HSL values
                var cycle = limit/(size);
                var saturation = 80, light = 50;
                var colors = [];

                for (var i = 0; i < size; i++) {
                    colors.push($.fn.hslToColor(Math.floor(cycle * i), saturation, light));
                }
                return colors;
            }
        });

        Wheel = (function($) {
            var l = $.fn.getObjectLength(Cycle.chromatic);
            console.log(l);
            var canvas,
                    properties = {
                        RADIUS: 120,
                        LINE_WIDTH: 90,
                        DIVIDER_WIDTH: 10,
                        DIVIDER_RADIUS: 170,
                        DIVIDER_COLOR: '#FFFFFF',
                        COUNTER_CLOCKWISE: false,
                        ARC_LENGTH: Math.PI / ($.fn.getObjectLength(Cycle.chromatic) / 2), // One-nth of the circle
                        SIZE: 500
                    };

            return {
                init: function(id) {
                    canvas = document.getElementById(id);
                    canvas.width = properties.SIZE;
                    canvas.height = properties.SIZE;
                    $.extend(properties, {
                        X: canvas.width / 2,
                        Y: canvas.height / 2
                    });
                },
                draw: function(colors) {
                    colors = colors || [];
                    var ctx = canvas.getContext('2d');

                    if (colors.length) {
                        $.each(colors, function(i, el) {
                            ctx.beginPath();
                            var begin = properties.ARC_LENGTH * i;
                            var end = begin + properties.ARC_LENGTH;

                            ctx.arc(properties.X, properties.Y, properties.RADIUS, begin, end, properties.COUNTER_CLOCKWISE);
                            ctx.lineWidth = properties.LINE_WIDTH;
                            // line color
                            ctx.strokeStyle = el;
                            ctx.stroke();
                        });

                        // Draw a star that creates the divisions between sections
                        ctx.translate(properties.X, properties.Y);
                        for (var i = 0; i < colors.length / 2; i++) {
                            window.console.log(i)
                            ctx.beginPath();
                            ctx.lineWidth = properties.DIVIDER_WIDTH;
                            // line color
                            ctx.strokeStyle = properties.DIVIDER_COLOR;
                            ctx.moveTo(-properties.DIVIDER_RADIUS, 0);
                            ctx.lineTo(properties.DIVIDER_RADIUS, 0);
                            ctx.stroke();
                            ctx.closePath();
                            ctx.rotate(properties.ARC_LENGTH);

                        }
                        ctx.translate(-properties.X, -properties.Y);


                    } else {
                        throw RangeException("No color array defined");
                    }

                }
            };
        })(jQuery);

        var restartSound = function(tone) {
            tone.soundLeft.unmute();
            tone.soundRight.unmute();
            tone.soundLeft.play();
        };

        var stopSound = function(tone) {
            tone.soundLeft.mute();
            tone.soundRight.mute();
        };

        $(document).ready(function() {
            Wheel.init('wheel');
            // Generate buttons.

            var colors = $.fn.getColorRainbow($.fn.getObjectLength(Cycle.chromatic));
            $.each(colors, function(i) {
                $('body').append('<span style="color: ' + colors[i] + ';">&#9608;</span>');
            });
            $.each(Cycle.chromatic, function(element, i) {
                // Start loading source files.


                // Generate buttons.
                var source = Handlebars.compile($('#note-button-template').html());
                var button = source({ id: element, name: Cycle.chromatic[element].symbol });
                $('body').append(button);

            });

            $('.note-name').on('click', function(e) {
                e.preventDefault();
                Cycle.togglePlay($(this).attr('id'));
            });

            Wheel.draw(colors);
        });
    </script>
    <style type="text/css">
        button {
            display: block;
            height: 22px;
            width: 30px;
            margin: 0.1em;
        }

        button.pressed {
            background-color: #CCC;
        }
    </style>
</head>
<body>
    <canvas id="wheel"></canvas>
</body>

<script id="note-button-template" type="text/x-handlebars-template">
    <button id="{{ id }}" class="note-name">{{ name }}</button>
</script>
</html>
