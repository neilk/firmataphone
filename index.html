<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="jquery-1.8.3.min.js"></script>
    <script src="handlebars-1.0.rc.1.js"></script>
    <script src="buzz.js"></script>
    <script>

        /**
         * todo:
         * add tones an octave above, but do not make them the , so that a
         */

        Cycle = (function() {
            var cycle = {};
            cycle.chromatic = {
                'c': 'c',
                'c-sharp': 'c♯',
                'd': 'd',
                'e-flat': 'e♭',
                'e': 'e',
                'f': 'f',
                'f-sharp': 'f♯',
                'g': 'g',
                'a-flat': 'a♭',
                'a': 'a',
                'b-flat': 'b♭',
                'b': 'b'
            };

            cycle.startSound = function(tone) {
                if (cycle.chromatic[tone].soundLeft && cycle.chromatic[tone].soundRight) {
                    cycle.chromatic[tone].soundLeft.bind('timeupdate', function(e) {
                        if (this.getTime() > 2.8) {
                            cycle.chromatic[tone].soundRight.play();
                            this.mute();
                        }
                    });

                    cycle.chromatic[tone].soundRight.bind('timeupdate', function(e) {
                        if (this.getTime() > 2.8) {
                            cycle.chromatic[tone].soundLeft.play();
                            this.mute();
                        }
                    });

                    cycle.chromatic[tone].soundLeft.bind('play', function(e) {
                        this.unmute();
                    });

                    cycle.chromatic[tone].soundRight.bind('play', function(e) {
                        this.unmute();
                        cycle.chromatic[tone].soundLeft.stop();
                    });

                } else {
                    throw new Exception('Sounds are not ready');
                }
            };

            // Initialize Cycle.chromatic
            $.each(cycle.chromatic, function(element, i) {
                var symbol = cycle.chromatic[element];
                cycle.chromatic[element] = {
                    symbol: symbol,
                    isPlaying: false
                };

                var pathTo = 'files/' + element + '.wav';
                $.ajax({
                    type: 'GET',
                    url: pathTo,
                    success: function() {
                        cycle.chromatic[element].soundLeft = new buzz.sound(pathTo, { loop: false });
                        cycle.chromatic[element].soundRight = new buzz.sound(pathTo, { loop: false });
                        // Hacked "seamless" playback
                        // http://forestmist.org/2010/04/html5-audio-loops/
                        // tl;dr: HTML5 Audio.loop doesn't work seamlessly in any browser.
                        // Two alternating sounds work around the gap.
                        cycle.chromatic[element].soundLeft.bind('timeupdate', function(e) {
                            if (this.getTime() > 2) {
                                cycle.chromatic[element].soundRight.play();
                                this.setTime(0);
                                this.pause();
                            }
                        });

                        cycle.chromatic[element].soundRight.bind('timeupdate', function(e) {
                            if (this.getTime() > 2) {
                                cycle.chromatic[element].soundLeft.play();
                                this.setTime(0);
                                this.pause();
                            }
                        });
                    },
                    error: function(jqxhr) {
                        console.log('how does this work');
                        console.log(jqxhr);

                    }
                })

            });

            cycle.togglePlay = function(noteName) {
                var tone = Cycle.chromatic[noteName];

                if (!tone) {
                    return false;
                }
                window.console.log(tone.isPlaying);

                if (tone.soundLeft) {
                    if (tone.isPlaying == false) {
                        restartSound(tone);
                        $('#' + noteName).addClass('pressed');
                    } else {
                        stopSound(tone);
                        $('#' + noteName).removeClass('pressed');
                    }

                    tone.isPlaying = !(tone.isPlaying);
                }
                return true;
            };

            return cycle;
        })();


        var restartSound = function(tone) {
            tone.soundLeft.unmute();
            tone.soundRight.unmute();
            tone.soundLeft.play();
        };

        var stopSound = function(tone) {
            tone.soundLeft.mute();
            tone.soundRight.mute();
        };

        $(document).ready(function() {
            window.console.log(Cycle);

            // Generate buttons.
            $.each(Cycle.chromatic, function(element, i) {
                // Start loading source files.


                // Generate buttons.
                var source = Handlebars.compile($('#note-button-template').html());
                var button = source({ id: element, name: Cycle.chromatic[element].symbol });
                $('body').append(button);

            });

            $('.note-name').on('click', function(e) {
                e.preventDefault();
                Cycle.togglePlay($(this).attr('id'));
            });


            var canvas = document.getElementById('circle');
            var context = canvas.getContext('2d');
            var x = canvas.width / 2;
            var y = canvas.height / 2;
            var radius = 75;
            var startAngle = 1.1 * Math.PI;
            var endAngle = 1.9 * Math.PI;
            var counterClockwise = false;

            context.beginPath();
            context.arc(x, y, radius, startAngle, endAngle, counterClockwise);
            context.lineWidth = 15;

            // line color
            context.strokeStyle = 'black';
            context.stroke();
        });
    </script>
    <style type="text/css">
        button {
            display: block;
            height: 22px;
            width: 30px;
            margin: 0.1em;
        }

        button.pressed {
            background-color: #CCC;
        }
    </style>
</head>
<body>
    <canvas id="circle" width="578" height="250"></canvas>
</body>

<script id="note-button-template" type="text/x-handlebars-template">
    <button id="{{ id }}" class="note-name">{{ name }}</button>
</script>
</html>
