<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="jquery-1.8.3.min.js"></script>
    <script src="buzz.js"></script>
    <script>

        /**
         * todo:
         * add tones an octave above, but do not make them the , so that a
         */

        Cycle = (function() {
            var cycle = {};
            cycle.chromatic = {
                'c': 'c',
                'd-flat': 'd♭',
                'd': 'd',
                'e-flat': 'e♭',
                'e': 'e',
                'f': 'f',
                'f-sharp' : 'f♯',
                'g': 'g',
                'a-flat': 'a♭',
                'a': 'a',
                'b-flat': 'b♭',
                'b': 'b'
            };


            cycle.fifths = [
                'a',
                'e',
                'b',
                'f-sharp',
                'd-flat',
                'a-flat',
                'e-flat',
                'b-flat',
                'f',
                'c',
                'g',
                'd'
            ];


            cycle.startSound = function(tone) {
                if (cycle.chromatic[tone].soundLeft && cycle.chromatic[tone].soundRight) {
                    cycle.chromatic[tone].soundLeft.bind('timeupdate', function(e) {
                        if (this.getTime() > 2.8) {
                            cycle.chromatic[tone].soundRight.play();
                            this.mute();
                        }
                    });

                    cycle.chromatic[tone].soundRight.bind('timeupdate', function(e) {
                        if (this.getTime() > 2.8) {
                            cycle.chromatic[tone].soundLeft.play();
                            this.mute();
                        }
                    });

                    cycle.chromatic[tone].soundLeft.bind('play', function(e) {
                        this.unmute();
                    });

                    cycle.chromatic[tone].soundRight.bind('play', function(e) {
                        this.unmute();
                        cycle.chromatic[tone].soundLeft.stop();
                    });

                } else {
                    throw new Exception('Sounds are not ready');
                }
            };

            // Initialize Cycle.chromatic
            $.each(cycle.chromatic, function(element, i) {
                var symbol = cycle.chromatic[element];
                cycle.chromatic[element] = {
                    symbol: symbol,
                    isPlaying: false
                };

                var pathTo = 'files/' + element + '.wav';
                $.ajax({
                    type: 'GET',
                    url: pathTo,
                    success: function() {
                        cycle.chromatic[element].soundLeft = new buzz.sound(pathTo, { loop: false });
                        cycle.chromatic[element].soundRight = new buzz.sound(pathTo, { loop: false });
                        // Hacked "seamless" playback
                        // http://forestmist.org/2010/04/html5-audio-loops/
                        // tl;dr: HTML5 Audio.loop doesn't work seamlessly in any browser.
                        // Two alternating sounds work around the gap.
                        cycle.chromatic[element].soundLeft.bind('timeupdate', function(e) {
                            if (this.getTime() > 2) {
                                cycle.chromatic[element].soundRight.play();
                                this.setTime(0);
                                this.pause();
                            }
                        });

                        cycle.chromatic[element].soundRight.bind('timeupdate', function(e) {
                            if (this.getTime() > 2) {
                                cycle.chromatic[element].soundLeft.play();
                                this.setTime(0);
                                this.pause();
                            }
                        });
                    },
                    error: function(jqxhr) {
                        console.log("Couldn't load file:", jqxhr);
                    }
                })

            });

            cycle.togglePlay = function(noteName) {
                var tone = Cycle.chromatic[noteName];

                if (!tone) {
                    return false;
                }
                window.console.log(tone.isPlaying);

                if (tone.soundLeft) {
                    if (tone.isPlaying == false) {
                        Cycle.restartSound(tone);
                    } else {
                        Cycle.stopSound(tone);
                    }

                    tone.isPlaying = !(tone.isPlaying);
                }
                return true;
            };

            cycle.getNoteSymbol = function(noteName) {
                return cycle.chromatic[noteName].symbol;
            };

            cycle.restartSound = function(tone) {
                tone.soundLeft.unmute();
                tone.soundRight.unmute();
                tone.soundLeft.play();
            };

            cycle.stopSound = function(tone) {
                tone.soundLeft.mute();
                tone.soundRight.mute();
            };
            return cycle;
        })();


        $.fn.extend({
             getObjectLength: function(obj) {
                 var size = 0;
                 for (var key in obj) {
                     if (obj.hasOwnProperty(key)) {
                         size++;
                     }
                 }
                 return size;
             },

            getObjectKeys: function(obj) {
                var result = [];
                for (var key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        result.push(key);
                    }
                }
                return result;
            },
            // From http://krazydad.com/tutorials/makecolors.php
            hslToColor: function(h, s, l) {
                return 'hsla(' + h + ',' + s + '%,' + l + '%, 0.7)';
            },

            getColorRainbow: function(size) {
                var limit = 360; // degrees of HSL values
                var cycle = limit/(size);
                var saturation = 80, light = 50;
                var colors = [];

                for (var i = 0; i < size; i++) {
                    colors.push($.fn.hslToColor(Math.floor(cycle * i), saturation, light));
                }
                return colors;
            }
        });

        Wheel = (function($) {
            var canvas,
                    properties = {
                        RADIUS: 120,
                        LINE_WIDTH: 90,
                        DIVIDER_WIDTH: 10,
                        DIVIDER_RADIUS: 170,
                        DIVIDER_COLOR: '#FFFFFF',
                        COUNTER_CLOCKWISE: false,
                        LABEL_RADIUS: 150,
                        ARC_LENGTH: Math.PI / ($.fn.getObjectLength(Cycle.chromatic) / 2), // One-nth of the circle
                        SIZE: 400
                    };

            return {
                init: function(id) {
                    canvas = document.getElementById(id);
                    canvas.width = properties.SIZE;
                    canvas.height = properties.SIZE;
                    $.extend(properties, {
                        X: canvas.width / 2,
                        Y: canvas.height / 2
                    });
                },
                draw: function(colors) {
                    colors = colors || [];
                    var ctx = canvas.getContext('2d');
                    var p = properties;

                    if (Cycle.chromatic && colors.length) {
                        var noteNames = $.fn.getObjectKeys(Cycle.chromatic);
                        window.console.log(noteNames[2]);
                        $.each(colors, function(i, el) {
                            ctx.beginPath();
                            var begin = p.ARC_LENGTH * i - (p.ARC_LENGTH/2);
                            var end = begin + p.ARC_LENGTH;

                            ctx.arc(p.X, p.Y, p.RADIUS, begin, end, p.COUNTER_CLOCKWISE);
                            ctx.lineWidth = p.LINE_WIDTH;
                            // line color
                            ctx.strokeStyle = el;
                            ctx.stroke();

                            var xCalculated = Math.cos(i * p.ARC_LENGTH) * p.LABEL_RADIUS,
                                    yCalculated = Math.sin(i * p.ARC_LENGTH) * p.LABEL_RADIUS;
                            var pos = {
                            // these values are invented
                                x: xCalculated - (0.15 * xCalculated) - 8,
                                y: yCalculated - (0.2 * yCalculated) - 16
                            };

                            $('#buttons').append(
                                '<a href="#" class="note-name" id="' + noteNames[i] + '" style="position: absolute; text-align: center; margin: 0; left: ' + pos.x + 'px; top: ' + pos.y + 'px">' + Cycle.getNoteSymbol(noteNames[i]) + '</a>'
                            );
                        });

                        // Draw a star that creates the divisions between sections
                        ctx.translate(p.X, p.Y);
                        ctx.rotate(p.ARC_LENGTH / 2);
                        for (var i = 0; i < colors.length / 2; i++) {
                            ctx.beginPath();
                            ctx.lineWidth = p.DIVIDER_WIDTH;
                            // line color
                            ctx.strokeStyle = p.DIVIDER_COLOR;
                            ctx.moveTo(-p.DIVIDER_RADIUS, 0);
                            ctx.lineTo(p.DIVIDER_RADIUS, 0);
                            ctx.stroke();
                            ctx.closePath();
                            ctx.rotate(p.ARC_LENGTH);
                        }
                        ctx.translate(-p.X, -p.Y);


                    } else {
                        throw RangeException("No color array defined");
                    }

                }
            };
        })(jQuery);


        $(document).ready(function() {
            Wheel.init('wheel');
            // Generate buttons.

            var colors = $.fn.getColorRainbow($.fn.getObjectLength(Cycle.chromatic));

            $('.note-name').live('click', function(e) {
                e.preventDefault();
                window.console.log('yay');
                Cycle.togglePlay($(this).attr('id'));
            });

            $('#kill').click(function(e) {
                e.preventDefault();
                $.each(Cycle.chromatic, function(i, el) {
                    if (el.isPlaying) {
                        Cycle.stopSound(el);
                        el.isPlaying = false;
                    }
                });
            });

            Wheel.draw(colors);
        });
    </script>
    <style type="text/css">
        body {
            font-size: 12px;
        }

        button.pressed {
            background-color: #CCC;
        }

        .note-name {
            font-size: 2em;
            letter-spacing: -2px;
            color: #000000;
            text-decoration: none;
        }

        button#kill {
            height: 40px;
            margin: 0.1em;
            font-size: 2em;
            width: auto;
            display: block;
            margin: 0 auto;
        }

        h1 {
            font-family: sans-serif;
            font-size: 3em;
        }

        #buttons {
            position: absolute;
            left: 200px;
            top: 200px;
            width: 200px;
            height: 200px;
        }

        #container {
            position: relative;
            width: 400px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
<h1>cranky chord generator makes angry chords :( </h1>
<div id="container" style="position: relative;">
    <canvas id="wheel"></canvas>
    <div id="buttons"></div>
    <button id="kill">hush</button>
</div>
</body>
</html>
